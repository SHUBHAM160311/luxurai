<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LuxurAI â€” Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Montserrat:wght@200;300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #C9A84C; --gold-light: #E8C97A; --gold-pale: #F5E6C0;
    --black: #080808; --black-2: #0F0F0F; --black-3: #161616; --black-4: #1E1E1E;
    --white: #F8F4ED; --white-dim: #C8C0B0; --gray: #888070;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--black); color:var(--white); font-family:'Montserrat',sans-serif; font-weight:300; min-height:100vh; }

  /* NAV */
  nav { position:fixed; top:0; left:0; right:0; z-index:100; padding:20px 48px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(201,168,76,0.1); background:rgba(8,8,8,0.92); backdrop-filter:blur(20px); }
  .logo { font-family:'Cormorant Garamond',serif; font-size:1.6rem; font-weight:600; letter-spacing:0.15em; color:var(--gold); text-decoration:none; }
  .logo span { color:var(--white); font-weight:300; }
  .nav-right { display:flex; align-items:center; gap:24px; }
  .nav-balance { background:rgba(201,168,76,0.08); border:1px solid rgba(201,168,76,0.2); color:var(--gold); padding:8px 20px; font-size:0.72rem; letter-spacing:0.15em; }
  .nav-topup { background:var(--gold); color:var(--black); padding:8px 20px; font-size:0.7rem; letter-spacing:0.15em; text-transform:uppercase; text-decoration:none; font-weight:500; transition:background 0.3s; }
  .nav-topup:hover { background:var(--gold-light); }
  .nav-signout { color:var(--gray); font-size:0.7rem; letter-spacing:0.1em; background:none; border:none; cursor:pointer; transition:color 0.3s; }
  .nav-signout:hover { color:var(--white); }

  /* LAYOUT */
  .layout { display:grid; grid-template-columns:220px 1fr; min-height:100vh; padding-top:68px; }

  /* SIDEBAR */
  .sidebar { background:var(--black-2); border-right:1px solid rgba(201,168,76,0.08); padding:40px 0; position:sticky; top:68px; height:calc(100vh - 68px); overflow-y:auto; }
  .sidebar-section { margin-bottom:8px; }
  .sidebar-label { font-size:0.58rem; letter-spacing:0.35em; text-transform:uppercase; color:var(--gray); padding:0 24px; margin-bottom:8px; }
  .sidebar-item { display:flex; align-items:center; gap:12px; padding:12px 24px; color:var(--white-dim); font-size:0.75rem; letter-spacing:0.1em; text-decoration:none; transition:all 0.2s; border-left:2px solid transparent; cursor:pointer; background:none; border-right:none; border-top:none; border-bottom:none; width:100%; text-align:left; font-family:'Montserrat',sans-serif; font-weight:300; }
  .sidebar-item:hover { color:var(--white); background:rgba(201,168,76,0.04); }
  .sidebar-item.active { color:var(--gold); border-left-color:var(--gold); background:rgba(201,168,76,0.06); }
  .sidebar-icon { font-size:1rem; width:18px; text-align:center; }

  /* MAIN */
  .main { padding:40px 48px; }
  .page { display:none; }
  .page.active { display:block; }

  /* PAGE HEADER */
  .page-header { margin-bottom:36px; }
  .page-title { font-family:'Cormorant Garamond',serif; font-size:2.2rem; font-weight:300; }
  .page-title em { font-style:italic; color:var(--gold); }
  .page-sub { color:var(--gray); font-size:0.75rem; letter-spacing:0.1em; margin-top:8px; }

  /* STAT CARDS */
  .stat-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-bottom:36px; }
  .stat-card { background:var(--black-3); border:1px solid rgba(201,168,76,0.08); padding:24px; }
  .stat-label { font-size:0.62rem; letter-spacing:0.25em; text-transform:uppercase; color:var(--gray); margin-bottom:12px; }
  .stat-val { font-family:'Cormorant Garamond',serif; font-size:2rem; font-weight:300; color:var(--white); }
  .stat-val.gold { color:var(--gold); }
  .stat-note { font-size:0.62rem; color:var(--gray); margin-top:6px; letter-spacing:0.05em; }

  /* GENERATE PANEL */
  .gen-panel { background:var(--black-3); border:1px solid rgba(201,168,76,0.1); padding:32px; margin-bottom:24px; }
  .gen-panel h3 { font-family:'Cormorant Garamond',serif; font-size:1.4rem; font-weight:300; margin-bottom:24px; }
  .gen-panel h3 em { color:var(--gold); font-style:italic; }
  textarea { width:100%; background:rgba(201,168,76,0.04); border:1px solid rgba(201,168,76,0.15); color:var(--white); padding:16px; font-family:'Montserrat',sans-serif; font-size:0.82rem; resize:vertical; min-height:90px; outline:none; transition:border-color 0.3s; letter-spacing:0.05em; }
  textarea:focus { border-color:rgba(201,168,76,0.4); }
  textarea::placeholder { color:var(--gray); }
  .res-row { display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; }
  .res-btn { background:transparent; border:1px solid rgba(201,168,76,0.15); color:var(--white-dim); padding:8px 16px; font-size:0.68rem; letter-spacing:0.1em; cursor:pointer; transition:all 0.2s; font-family:'Montserrat',sans-serif; }
  .res-btn.active, .res-btn:hover { border-color:var(--gold); color:var(--gold); }
  .res-btn .lc { font-size:0.6rem; color:var(--gray); margin-left:6px; }
  .res-btn.active .lc { color:var(--gold-dark); }
  .addon-row { display:flex; gap:10px; margin-top:12px; }
  .addon-btn { background:transparent; border:1px solid rgba(201,168,76,0.12); color:var(--white-dim); padding:8px 16px; font-size:0.68rem; letter-spacing:0.1em; cursor:pointer; transition:all 0.2s; font-family:'Montserrat',sans-serif; }
  .addon-btn.active { border-color:var(--gold); color:var(--gold); background:rgba(201,168,76,0.06); }
  .gen-footer { display:flex; align-items:center; justify-content:space-between; margin-top:20px; }
  .cost-pill { background:rgba(201,168,76,0.08); border:1px solid rgba(201,168,76,0.15); padding:10px 20px; font-size:0.72rem; color:var(--white-dim); letter-spacing:0.1em; }
  .cost-pill strong { color:var(--gold); }
  .gen-btn { background:var(--gold); color:var(--black); padding:12px 36px; font-family:'Montserrat',sans-serif; font-size:0.72rem; font-weight:500; letter-spacing:0.2em; text-transform:uppercase; border:none; cursor:pointer; transition:background 0.3s; }
  .gen-btn:hover { background:var(--gold-light); }
  .gen-btn:disabled { opacity:0.5; cursor:not-allowed; }

  /* QUEUE TOAST */
  .queue-toast { position:fixed; bottom:32px; right:32px; background:var(--black-3); border:1px solid rgba(201,168,76,0.2); padding:20px 24px; min-width:280px; z-index:999; transform:translateY(120px); opacity:0; transition:all 0.4s ease; }
  .queue-toast.show { transform:translateY(0); opacity:1; }
  .queue-title { font-size:0.72rem; letter-spacing:0.2em; color:var(--gold); text-transform:uppercase; margin-bottom:10px; }
  .queue-meta { display:flex; gap:20px; margin-bottom:8px; font-size:0.68rem; color:var(--white-dim); }
  .queue-status { font-size:0.72rem; color:var(--white-dim); margin-bottom:12px; }
  .queue-progress { height:2px; background:rgba(201,168,76,0.1); }
  .queue-progress-bar { height:100%; background:var(--gold); width:0%; transition:width 0.5s ease; }

  /* HISTORY */
  .history-table { width:100%; border-collapse:collapse; }
  .history-table th { text-align:left; font-size:0.6rem; letter-spacing:0.25em; text-transform:uppercase; color:var(--gray); padding:0 16px 16px; border-bottom:1px solid rgba(201,168,76,0.08); }
  .history-table td { padding:16px; border-bottom:1px solid rgba(201,168,76,0.06); font-size:0.75rem; color:var(--white-dim); vertical-align:middle; }
  .history-table tr:hover td { background:rgba(201,168,76,0.02); }
  .status-badge { display:inline-block; padding:3px 10px; font-size:0.6rem; letter-spacing:0.15em; text-transform:uppercase; }
  .status-badge.done { background:rgba(80,180,90,0.1); color:#7dd87d; }
  .status-badge.queued { background:rgba(201,168,76,0.1); color:var(--gold); }
  .status-badge.running { background:rgba(100,160,255,0.1); color:#88aaff; }
  .status-badge.failed { background:rgba(255,80,80,0.1); color:#ff8080; }
  .thumb-img { width:40px; height:40px; object-fit:cover; background:var(--black-4); }
  .dl-link { color:var(--gold); font-size:0.65rem; text-decoration:none; letter-spacing:0.1em; }
  .dl-link:hover { color:var(--gold-light); }
  .prompt-cell { max-width:280px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  /* WALLET */
  .wallet-grid { display:grid; grid-template-columns:1fr 1fr; gap:24px; }
  .wallet-card { background:var(--black-3); border:1px solid rgba(201,168,76,0.08); padding:28px; }
  .wallet-card h3 { font-size:0.65rem; letter-spacing:0.25em; text-transform:uppercase; color:var(--gray); margin-bottom:20px; }
  .balance-big { font-family:'Cormorant Garamond',serif; font-size:3.5rem; font-weight:300; color:var(--gold); line-height:1; }
  .balance-inr { font-size:0.75rem; color:var(--gray); margin-top:8px; letter-spacing:0.1em; }
  .topup-link { display:inline-block; margin-top:20px; background:var(--gold); color:var(--black); padding:10px 28px; font-size:0.7rem; font-weight:500; letter-spacing:0.15em; text-decoration:none; transition:background 0.3s; }
  .topup-link:hover { background:var(--gold-light); }
  .ledger-row { display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid rgba(201,168,76,0.06); font-size:0.72rem; }
  .ledger-row:last-child { border-bottom:none; }
  .ledger-reason { color:var(--white-dim); letter-spacing:0.05em; }
  .ledger-delta { font-weight:500; }
  .ledger-delta.credit { color:#7dd87d; }
  .ledger-delta.debit { color:#ff8080; }
  .ledger-date { font-size:0.6rem; color:var(--gray); }

  /* API KEYS */
  .apikey-card { background:var(--black-3); border:1px solid rgba(201,168,76,0.08); padding:28px; margin-bottom:16px; }
  .apikey-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
  .apikey-label { font-size:0.65rem; letter-spacing:0.25em; text-transform:uppercase; color:var(--gray); }
  .apikey-val { font-family:monospace; font-size:0.78rem; color:var(--gold); letter-spacing:0.08em; background:rgba(201,168,76,0.05); padding:8px 14px; border:1px solid rgba(201,168,76,0.12); }
  .apikey-actions { display:flex; gap:10px; margin-top:14px; }
  .apikey-btn { background:transparent; border:1px solid rgba(201,168,76,0.2); color:var(--white-dim); padding:7px 18px; font-size:0.65rem; letter-spacing:0.15em; cursor:pointer; font-family:'Montserrat',sans-serif; transition:all 0.2s; }
  .apikey-btn:hover { border-color:var(--gold); color:var(--gold); }
  .apikey-btn.danger:hover { border-color:#ff8080; color:#ff8080; }
  .apikey-meta { font-size:0.62rem; color:var(--gray); }
  .create-key-btn { background:transparent; border:1px solid rgba(201,168,76,0.3); color:var(--gold); padding:12px 28px; font-family:'Montserrat',sans-serif; font-size:0.7rem; letter-spacing:0.18em; cursor:pointer; transition:all 0.3s; margin-bottom:24px; }
  .create-key-btn:hover { background:rgba(201,168,76,0.08); }
  .new-key-banner { background:rgba(80,180,90,0.08); border:1px solid rgba(80,180,90,0.2); padding:16px 20px; margin-bottom:20px; display:none; }
  .new-key-banner.show { display:block; }
  .new-key-title { font-size:0.65rem; letter-spacing:0.2em; text-transform:uppercase; color:#7dd87d; margin-bottom:8px; }
  .new-key-val { font-family:monospace; font-size:0.8rem; color:var(--white); word-break:break-all; }
  .new-key-warn { font-size:0.65rem; color:var(--gray); margin-top:8px; }

  /* EMPTY STATE */
  .empty-state { text-align:center; padding:60px 0; color:var(--gray); }
  .empty-icon { font-size:2.5rem; margin-bottom:16px; opacity:0.4; }
  .empty-text { font-size:0.75rem; letter-spacing:0.1em; }

  /* LOADING */
  .loading { color:var(--gray); font-size:0.72rem; letter-spacing:0.15em; padding:40px 0; text-align:center; }
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <a href="/pages/index.html" class="logo">Luxur<span>AI</span></a>
  <div class="nav-right">
    <div class="nav-balance">âœ¦ <span id="navBalance">â€”</span> LC</div>
    <a href="/pages/payment.html" class="nav-topup">Top Up</a>
    <button class="nav-signout" onclick="signOut()">Sign Out</button>
  </div>
</nav>

<!-- LAYOUT -->
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Create</div>
      <button class="sidebar-item active" onclick="showPage('generate', this)">
        <span class="sidebar-icon">âœ¦</span> Generate
      </button>
      <button class="sidebar-item" onclick="showPage('history', this)">
        <span class="sidebar-icon">ğŸ•</span> History
      </button>
    </div>
    <div class="sidebar-section" style="margin-top:24px">
      <div class="sidebar-label">Account</div>
      <button class="sidebar-item" onclick="showPage('wallet', this)">
        <span class="sidebar-icon">â—ˆ</span> Wallet
      </button>
      <button class="sidebar-item" onclick="showPage('apikeys', this)">
        <span class="sidebar-icon">âŒ˜</span> API Keys
      </button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">

    <!-- GENERATE PAGE -->
    <div class="page active" id="page-generate">
      <div class="page-header">
        <div class="page-title">Start <em>Creating</em></div>
        <div class="page-sub">Your LC balance is ready</div>
      </div>

      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-label">LC Balance</div>
          <div class="stat-val gold" id="statBalance">â€”</div>
          <div class="stat-note">â‰ˆ â‚¹<span id="statInr">â€”</span></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Generated</div>
          <div class="stat-val" id="statTotal">â€”</div>
          <div class="stat-note">images</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Completed</div>
          <div class="stat-val" id="statDone">â€”</div>
          <div class="stat-note">successful</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">LC Spent</div>
          <div class="stat-val" id="statSpent">â€”</div>
          <div class="stat-note">all time</div>
        </div>
      </div>

      <div class="gen-panel">
        <h3>New <em>Generation</em></h3>
        <textarea id="promptInput" placeholder="Describe your image in detail â€” the more specific, the better..."></textarea>

        <div class="res-row" id="resRow">
          <button class="res-btn" onclick="selectRes(this,'100x100')">100Ã—100 <span class="lc">0.5 LC</span></button>
          <button class="res-btn active" onclick="selectRes(this,'200x200')">200Ã—200 <span class="lc">1 LC</span></button>
          <button class="res-btn" onclick="selectRes(this,'500x500')">500Ã—500 <span class="lc">3 LC</span></button>
          <button class="res-btn" onclick="selectRes(this,'512x1024')">512Ã—1024 <span class="lc">6 LC</span></button>
          <button class="res-btn" onclick="selectRes(this,'1024x1024')">1024Ã—1024 <span class="lc">9 LC</span></button>
        </div>

        <div class="addon-row">
          <button class="addon-btn" id="fastBtn" onclick="toggleAddon('fast')">âš¡ Fast Gen +3 LC</button>
          <button class="addon-btn" id="watermarkBtn" onclick="toggleAddon('watermark')">ğŸš« No Watermark +7 LC</button>
        </div>

        <div class="gen-footer">
          <div class="cost-pill">Cost: <strong id="costDisplay">1 LC</strong> &nbsp;Â·&nbsp; â‚¹<span id="costInr">0.25</span></div>
          <button class="gen-btn" id="genBtn" onclick="submitGenerate()">Generate Image</button>
        </div>
      </div>
    </div>

    <!-- HISTORY PAGE -->
    <div class="page" id="page-history">
      <div class="page-header">
        <div class="page-title">Generation <em>History</em></div>
        <div class="page-sub">All your creations</div>
      </div>
      <div id="historyContent"><div class="loading">Loading history...</div></div>
    </div>

    <!-- WALLET PAGE -->
    <div class="page" id="page-wallet">
      <div class="page-header">
        <div class="page-title">Your <em>Wallet</em></div>
        <div class="page-sub">LC balance and transaction history</div>
      </div>
      <div class="wallet-grid">
        <div class="wallet-card">
          <h3>Balance</h3>
          <div class="balance-big" id="walletBalance">â€”</div>
          <div class="balance-inr">â‰ˆ â‚¹<span id="walletInr">â€”</span> at â‚¹0.25/LC</div>
          <a href="/pages/payment.html" class="topup-link">Top Up Wallet</a>
        </div>
        <div class="wallet-card">
          <h3>Recent Transactions</h3>
          <div id="ledgerList"><div class="loading">Loading...</div></div>
        </div>
      </div>
    </div>

    <!-- API KEYS PAGE -->
    <div class="page" id="page-apikeys">
      <div class="page-header">
        <div class="page-title">API <em>Keys</em></div>
        <div class="page-sub">Manage developer access</div>
      </div>
      <div class="new-key-banner" id="newKeyBanner">
        <div class="new-key-title">âœ“ New API Key â€” Save this now</div>
        <div class="new-key-val" id="newKeyVal"></div>
        <div class="new-key-warn">âš  This key will not be shown again.</div>
      </div>
      <button class="create-key-btn" onclick="createApiKey()">+ Generate New API Key</button>
      <div id="apiKeysList"><div class="loading">Loading...</div></div>
    </div>

  </main>
</div>

<!-- QUEUE TOAST -->
<div class="queue-toast" id="queueToast">
  <div class="queue-title">âœ¦ Generating your image</div>
  <div class="queue-meta">
    <span id="queuePos">Position <strong>#1</strong></span>
    <span>ETA <strong id="etaCount">~8s</strong></span>
  </div>
  <div class="queue-status" id="queueStatus">Submitting...</div>
  <div class="queue-progress"><div class="queue-progress-bar" id="queueBar"></div></div>
</div>

<script>
  const API = 'https://luxurai.in';
  let lcBal = 0, selectedRes = '200x200', fastActive = false, watermarkActive = false;
  let pollTimer = null;

  // â”€â”€ Auth guard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    try {
      const res = await fetch(`${API}/api/auth/me`, { credentials: 'include' });
      if (!res.ok) { window.location.href = '/pages/index.html'; return; }
      const user = await res.json();
      lcBal = user.balance_lc ?? 0;
      updateBalanceDisplay();
      loadDashboard();
    } catch { window.location.href = '/pages/index.html'; }
  }

  async function loadDashboard() {
    try {
      const res = await fetch(`${API}/api/ux/dashboard`, { credentials: 'include' });
      const data = await res.json();
      lcBal = data.balance_lc;
      document.getElementById('statBalance').textContent = lcBal.toFixed(1);
      document.getElementById('statInr').textContent    = (lcBal * 0.25).toFixed(2);
      document.getElementById('statTotal').textContent  = data.total_jobs;
      document.getElementById('statDone').textContent   = data.completed;
      document.getElementById('statSpent').textContent  = data.lc_spent;
      updateBalanceDisplay();
    } catch {}
  }

  function updateBalanceDisplay() {
    document.getElementById('navBalance').textContent = lcBal.toFixed(1);
    updateCost();
  }

  // â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showPage(name, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active'));
    document.getElementById('page-' + name).classList.add('active');
    btn.classList.add('active');

    if (name === 'history')  loadHistory();
    if (name === 'wallet')   loadWallet();
    if (name === 'apikeys')  loadApiKeys();
  }

  // â”€â”€ Resolution & addons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const COST = { '100x100':0.5, '200x200':1, '500x500':3, '512x1024':6, '1024x1024':9 };

  function selectRes(btn, res) {
    document.querySelectorAll('.res-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedRes = res;
    updateCost();
  }

  function toggleAddon(type) {
    if (type === 'fast') {
      fastActive = !fastActive;
      document.getElementById('fastBtn').classList.toggle('active', fastActive);
    } else {
      watermarkActive = !watermarkActive;
      document.getElementById('watermarkBtn').classList.toggle('active', watermarkActive);
    }
    updateCost();
  }

  function updateCost() {
    const total = (COST[selectedRes] ?? 1) + (fastActive ? 3 : 0) + (watermarkActive ? 7 : 0);
    document.getElementById('costDisplay').textContent = total + ' LC';
    document.getElementById('costInr').textContent     = (total * 0.25).toFixed(2);
    document.getElementById('genBtn').disabled         = total > lcBal;
  }

  // â”€â”€ Generate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function submitGenerate() {
    const prompt = document.getElementById('promptInput').value.trim();
    if (!prompt) { document.getElementById('promptInput').focus(); return; }

    const btn = document.getElementById('genBtn');
    btn.disabled = true; btn.textContent = 'Submitting...';

    const toast  = document.getElementById('queueToast');
    const bar    = document.getElementById('queueBar');
    const status = document.getElementById('queueStatus');
    const posEl  = document.getElementById('queuePos');
    const etaEl  = document.getElementById('etaCount');

    toast.classList.add('show');
    bar.style.width = '5%';
    status.textContent = 'Submitting job...';

    try {
      const res = await fetch(`${API}/api/ux/generate`, {
        method: 'POST', credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, resolution: selectedRes, fast: fastActive, no_watermark: watermarkActive })
      });

      if (res.status === 402) { window.location.href = '/pages/payment.html'; return; }
      if (!res.ok) throw new Error('Failed');

      const job = await res.json();
      let pos = job.queue_position ?? 0;
      let eta = job.eta_seconds ?? 8;

      posEl.innerHTML = `Position <strong>#${pos + 1}</strong>`;
      etaEl.textContent = '~' + eta + 's';
      status.textContent = 'Joined queue...';
      bar.style.width = '15%';

      lcBal = Math.max(0, lcBal - job.cost_lc);
      updateBalanceDisplay();
      btn.textContent = 'Generate Image';

      const etaTimer = setInterval(() => { eta = Math.max(0,eta-1); etaEl.textContent='~'+eta+'s'; if(eta<=0)clearInterval(etaTimer); }, 1000);

      pollTimer = setInterval(async () => {
        try {
          const p = await fetch(`${API}/api/ux/job/${job.job_id}`, { credentials: 'include' });
          const j = await p.json();
          if (j.queue_position != null) {
            posEl.innerHTML = `Position <strong>#${j.queue_position + 1}</strong>`;
            bar.style.width = Math.min(80, 20 + (1 - j.queue_position/5)*60) + '%';
          }
          if (j.status === 'running') { status.textContent = 'Rendering...'; bar.style.width = '78%'; }
          if (j.status === 'done') {
            clearInterval(pollTimer); clearInterval(etaTimer);
            bar.style.width = '100%'; status.textContent = 'âœ“ Complete!';
            posEl.innerHTML = `<strong style="color:#7dd87d">âœ“ Done</strong>`;
            setTimeout(() => { toast.classList.remove('show'); btn.disabled=false; loadHistory(); }, 2500);
          }
          if (j.status === 'failed') {
            clearInterval(pollTimer); clearInterval(etaTimer);
            status.textContent = 'âœ• Failed â€” LC refunded';
            lcBal += job.cost_lc; updateBalanceDisplay(); btn.disabled=false;
            setTimeout(() => toast.classList.remove('show'), 3000);
          }
        } catch {}
      }, 2000);

    } catch { status.textContent = 'Error â€” please try again.'; btn.disabled=false; setTimeout(()=>toast.classList.remove('show'),3000); }
  }

  // â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadHistory() {
    const el = document.getElementById('historyContent');
    el.innerHTML = '<div class="loading">Loading...</div>';
    try {
      const res = await fetch(`${API}/api/ux/history`, { credentials: 'include' });
      const data = await res.json();
      if (!data.jobs.length) {
        el.innerHTML = '<div class="empty-state"><div class="empty-icon">âœ¦</div><div class="empty-text">No generations yet. Start creating!</div></div>';
        return;
      }
      el.innerHTML = `
        <table class="history-table">
          <thead><tr><th>Image</th><th>Prompt</th><th>Resolution</th><th>Cost</th><th>Status</th><th>Date</th><th></th></tr></thead>
          <tbody>
            ${data.jobs.map(j => `
              <tr>
                <td>${j.image_url ? `<img class="thumb-img" src="${j.image_url}">` : '<div class="thumb-img"></div>'}</td>
                <td><div class="prompt-cell" title="${j.prompt}">${j.prompt}</div></td>
                <td style="color:var(--white-dim)">${j.resolution}</td>
                <td style="color:var(--gold)">${j.cost_lc} LC</td>
                <td><span class="status-badge ${j.status}">${j.status}</span></td>
                <td style="font-size:0.65rem;color:var(--gray)">${new Date(j.created_at).toLocaleDateString('en-IN')}</td>
                <td>${j.image_url ? `<a href="${j.image_url}" download class="dl-link">â†“ Save</a>` : ''}</td>
              </tr>`).join('')}
          </tbody>
        </table>`;
    } catch { el.innerHTML = '<div class="empty-state"><div class="empty-text">Failed to load history.</div></div>'; }
  }

  // â”€â”€ Wallet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadWallet() {
    try {
      const res = await fetch(`${API}/api/ux/wallet`, { credentials: 'include' });
      const data = await res.json();
      lcBal = data.balance_lc;
      document.getElementById('walletBalance').textContent = lcBal.toFixed(1);
      document.getElementById('walletInr').textContent     = (lcBal * 0.25).toFixed(2);
      updateBalanceDisplay();

      const el = document.getElementById('ledgerList');
      if (!data.ledger.length) { el.innerHTML = '<div style="color:var(--gray);font-size:0.72rem">No transactions yet.</div>'; return; }
      el.innerHTML = data.ledger.map(e => `
        <div class="ledger-row">
          <div>
            <div class="ledger-reason">${e.reason.replace(/_/g,' ')}</div>
            <div class="ledger-date">${new Date(e.created_at).toLocaleString('en-IN')}</div>
          </div>
          <div class="ledger-delta ${e.delta_lc > 0 ? 'credit' : 'debit'}">${e.delta_lc > 0 ? '+' : ''}${e.delta_lc} LC</div>
        </div>`).join('');
    } catch {}
  }

  // â”€â”€ API Keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadApiKeys() {
    const el = document.getElementById('apiKeysList');
    el.innerHTML = '<div class="loading">Loading...</div>';
    try {
      const res = await fetch(`${API}/api/ux/apikey/list`, { credentials: 'include' });
      const data = await res.json();
      if (!data.keys.length) {
        el.innerHTML = '<div class="empty-state"><div class="empty-icon">âŒ˜</div><div class="empty-text">No API keys yet. Generate one above.</div></div>';
        return;
      }
      el.innerHTML = data.keys.map(k => `
        <div class="apikey-card">
          <div class="apikey-header">
            <div>
              <div class="apikey-label">${k.label || 'API Key'}</div>
              <div class="apikey-meta" style="margin-top:4px">Created ${new Date(k.created_at).toLocaleDateString('en-IN')} Â· ${k.total_calls} calls${k.last_used ? ' Â· Last used '+new Date(k.last_used).toLocaleDateString('en-IN') : ''}</div>
            </div>
            <span class="status-badge ${k.is_active ? 'done' : 'failed'}">${k.is_active ? 'Active' : 'Revoked'}</span>
          </div>
          <div class="apikey-val">${k.display}</div>
          <div class="apikey-actions">
            <button class="apikey-btn" onclick="rotateKey('${k.key_id}')">â†º Rotate</button>
            <button class="apikey-btn danger" onclick="revokeKey('${k.key_id}')">âœ• Revoke</button>
          </div>
        </div>`).join('');
    } catch { el.innerHTML = '<div class="empty-state"><div class="empty-text">Failed to load keys.</div></div>'; }
  }

  async function createApiKey() {
    try {
      const res = await fetch(`${API}/api/ux/apikey/create`, {
        method: 'POST', credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ label: 'My API Key' })
      });
      const data = await res.json();
      if (data.full_key) {
        document.getElementById('newKeyVal').textContent   = data.full_key;
        document.getElementById('newKeyBanner').classList.add('show');
        loadApiKeys();
      }
    } catch {}
  }

  async function rotateKey(keyId) {
    if (!confirm('Rotate this key? Old key stops working immediately.')) return;
    try {
      const res = await fetch(`${API}/api/ux/apikey/rotate?key_id=${keyId}`, { method:'POST', credentials:'include' });
      const data = await res.json();
      document.getElementById('newKeyVal').textContent = data.full_key;
      document.getElementById('newKeyBanner').classList.add('show');
      loadApiKeys();
    } catch {}
  }

  async function revokeKey(keyId) {
    if (!confirm('Revoke this key? It cannot be undone.')) return;
    try {
      await fetch(`${API}/api/ux/apikey/${keyId}`, { method:'DELETE', credentials:'include' });
      loadApiKeys();
    } catch {}
  }

  // â”€â”€ Sign out â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function signOut() {
    await fetch(`${API}/api/auth/signout`, { method:'POST', credentials:'include' });
    window.location.href = '/pages/index.html';
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  updateCost();
  init();
</script>
</body>
</html>
